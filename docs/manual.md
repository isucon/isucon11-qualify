# ISUCON11 予選当日マニュアル

**本マニュアルならびに、[ISUCON11 予選レギュレーション](https://isucon.net/archives/55854734.html) をご確認ください。**
**本マニュアルとレギュレーションの内容に矛盾がある場合、本マニュアルの内容が優先されます**

## スケジュール

- 10:00 競技開始
- 17:00 ポータルサイト リーダーボードの更新停止
- 18:00 競技終了
- 以降、主催者により結果チェック、追試

## 課題アプリケーション ISUCONDITION について

### 課題アプリケーション仕様

課題アプリケーション ISUCONDITION の仕様については、[ISUCONDITION アプリケーションマニュアル](TODO)を参照してください。

## ISUCON11 予選 ポータルサイト

ISUCON11 予選競技は下記ポータルサイトを利用します。
事前に登録した情報を用いてログインしてください。
なお、このページは競技開始時刻までアクセスすることはできません。

ポータルサイトでは、ベンチマークの実行・結果確認、質問/サポート依頼の送信、リーダーボードの確認ができます。

https://portal.isucon.net/contestant

### リーダーボードの更新について

ポータルサイト上のリーダーボードのスコアは、競技終了前の 1 時間は他チームのスコアが更新されなくなり、自チームのスコアのみ確認が可能になります。

### Discord の利用について

ISUCON 11 サポート Discord サーバーは競技中ならびにその前後の時間はすべてのチャンネルが発言不可となります。
競技時間中はポータルサイトを通して質問やサポート依頼を送信することができますので、そちらを利用してください。

ただし、予選参加者（以下選手）は競技時間中も Discord の確認が可能な状態、通知が受け取れる状態を維持してください。
これはポータルで送信した質問/サポート依頼の内容を主催者が確認した上で、リアルタイムでのチャットが必要だと判断した場合、主催者が Discord 上でプライベートチャンネルを作成し、mention の上よびかけを行う場合があるためです。

また、主催者からのアナウンス等も Discord で実施されます。

### 質問について

選手は主催者へ質問を送信することができます。質問は競技内容・マニュアル・レギュレーション等に対する疑問点・明確にしたい事項の確認や、サーバー障害などのトラブル報告・サポート依頼に利用することができるが、これに限りません。

主催者は質問された内容について競技の一環である場合は、回答できない旨を返答することがあります。

競技時間中の質問について、主催者からの回答は全選手へ公開、あるいは個別に回答されます。全選手へ公開される場合、質問内容の原文、あるいは主催者による内容の要約が公開されます。未回答の質問・未公開の回答については質問した選手およびそのチームメンバー、主催者のみが確認できます。質問への回答/更新はポータル上にて選手およびそのチームへ通知されます。

主催者は競技時間中の質問への回答について、原則として全選手へ公開します。ただし、重複する質問や、選手およびチーム個別の問題 (サーバー障害など) に対する対応の場合、この限りではありません。


## サーバー、ネットワーク構成について

**ToDo:構築方法についてポータルチーム、Infra班と確認**
AWS CloudFormation で構築するサーバーは 3 台あり、これらのサーバーに SSH を用いて接続し競技を行います。

上記のサーバーに接続するために SSH 接続を行います。
[ssh_config(5)](https://man.openbsd.org/ssh_config.5) の例を以下に示します。なお、あくまで例示であり必ず以下の設定を利用する必要はありません。

```
 Host isucon-server1
   HostName **<Elastic IPアドレス 1>**
   User ubuntu

Host isucon-server2
   HostName **<Elastic IPアドレス 2>**
   User ubuntu

Host isucon-server3
   HostName **<Elastic IPアドレス 3>**
   User ubuntu
```

### 重要事項

- **競技に利用できる計算機資源は主催者が公開した上記の所定手順で起動された EC2 インスタンスのみです。** 
  - 特例として外部のメトリクス計測サービスの使用のみ許可をしますが、スコアを向上させるいかなる効果も持つものであってはいけません。
- **競技終了後は、ベンチマーク走行成績の追試を行いますので、Discord サーバー および http://isucon.net/ にて主催者からお知らせをするまで、サーバーの操作はしないでください。**
  - 競技終了後の作業は禁止行為にあたり失格となります。
- **サーバー上の`ubuntu` ならびに `isucon` 以外のユーザに関して、ユーザ削除や既存の公開鍵の削除、その他 sshd の設定変更等を行ったことにより、主催者による追試をおこなうことができない場合は、失格とします。**


## 作業手順

以下の順序で作業を開始してください。

### 1. サーバーへのログイン

上記に記載したサーバーに対して SSH 接続してください。
ログインには参加登録に利用した ( = ポータルのログインに利用している) GitHub アカウントに登録されている SSH 鍵を利用します。

SSH ログインのユーザ名は `ubuntu` です。 (MEMO: 解く会では `isucon` になっているので以下 `ubuntu` ユーザは `isucon` に読み替えてください)

### 2. アプリケーションの動作確認 (ToDo)

アプリケーションは Web ブラウザから利用することができます。

ブラウザアクセスには、 [SSH におけるローカルポートフォワーディング](https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding#Local_Port_Forwarding) などを用いて表示することができます。
これ以外の方法で動作確認してもかまいません。

以下にローカルポートフォワーディングを実行するコマンドを例示します。
これは「リモートホスト `isucon-server1` に SSH 接続をした上で」「ローカルの `localhost:8080` への TCP 接続を」「リモートホストを通して `10.160.1.101:80` へ転送する」というコマンドです。

```shell
$ ssh -L localhost:8080:10.160.1.101:80 isucon-server1
```

以上を踏まえると、上記のコマンド例を実行している場合、 http://localhost:8080 でアプリケーションへアクセスすることができます。

#### アプリケーションへのログイン方法

ログインにはJapan ISU Association（以下JIA）のアカウントが必要です。
上記のアプリケーション同様にJIAへローカルポートフォワーディングをするためには下記のようにします。

```shell
$ ssh -L localhost:8080:10.160.1.101:80 -L localhost:5000:10.160.1.101:5000 isucon-server1
```

以下は http://localhost:8080 でアプリケーションへ、http://localhost:5000 でJIAへアクセスできるように設定した場合の例です。

- ISUCONDITION Topページ
  - http://localhost:8080/


- JIA のログインページ
  - http://localhost:5000/

MEMO: 本番ではHTTPSで接続できるようにするので `/etc/hosts` 周りの話と、上記からポート 80 番の話を削る（5000番はそのままに）

下記の 4 ユーザが登録されているので、動作確認にご利用ください。ログインはトップページから行うことができます。

| ログイン ID (contestant_id) | パスワード | 備考     |
| --------------------------- | ---------- | -------- |
| isucon                      | isucon     | 初期ユーザ |
| isucon1                     | isucon1    | 初期ユーザ |
| isucon2                     | isucon2    | 初期ユーザ |
| isucon3                     | isucon3    | 初期ユーザ |

#### ISUの登録に使えるJIA ISU IDについて

アプリケーションの動作確認用に以下のJIA ISU IDが登録に使うことができます。

| JIA ISU ID |
| --------- |
| 0694e4d7-dfce-4aec-b7ca-887ac42cfb8f |
| 3a8ae675-3702-45b5-b1eb-1e56e96738ea |
| 3efff0fa-75bc-4e3c-8c9d-ebfa89ecd15e |
| f67fcb64-f91c-4e7b-a48d-ddf1164194d0 |
| 32d1c708-e6ef-49d0-8ca9-4fd51844dcc8 |
| f012233f-c50e-4349-9473-95681becff1e |
| af64735c-667a-4d95-a75e-22d0c76083e0 |
| cb68f47f-25ef-46ec-965b-d72d9328160f |
| 57d600ef-15b4-43bc-ab79-6399fab5c497 |
| aa0844e6-812d-41d2-908a-eeb82a50b627 |

ISUの登録はログイン後に以下のURLで行うことができます。

- http://localhost:3000/register

#### データベースの初期化方法

初期状態のアプリケーションでは、初期化処理（`POST /initialize`）においてデータベースのレコードを削除し、スキーマは初期化します。

TODO: DBスキーマをいじって壊してしまった際の初期化方法を書く。

#### 動作確認に必要なアプリケーション

JIA　API Mock はJIAのページを模したアプリケーションであり、ローカルでの開発/動作検証に利用することができます。

- ISUCONDITIONへログインするためのトークンの発行 (`POST /api/auth`)
- 仮想ISUの登録（アクティベート） (`POST /api/activate`)
- 登録した仮想ISUからISUCONDITIONへ向けたコンディションの送信

登録したISUからのコンディション送信を止める場合は JIA API Mockのサービスを以下のように再起動して下さい。
   
```shell
sudo systemctl restart jiaapi-mock.service
```

#### ローカルでの開発方法

ローカルでの動作検証には上記アプリケーションへのログイン方法を参考にサーバー上の JIA API Mock へのローカルポートフォワーディングが必要です。

```
$ ssh -L localhost:5000:10.160.1.101:5000 isucon-server
```

アプリケーションの動作確認はWebブラウザから行うことができますが、下記のようにトークンの取得とcookieの設定を行うことでコンソールからもAPIへのアクセスが可能です。

```
TOKEN=`curl -sf -H 'content-type: application/json' http://localhost:5000/api/auth -d '{"user": "isucon", "password": "isucon"}'`
curl -c cookie.txt -vf -XPOST -H "authorization: Bearer ${TOKEN}" http://localhost:3000/api/auth
curl -b cookie.txt http://localhost:3000/api/isu
```

`POST /api/condition/:jia_isu_uuid` の検証

"ISUの登録に使えるJIA ISU IDについて" に記載されている JIA ISU ID を用いてアクティベートを行ったISUから
送信されるコンディションは下記の様にデータを送信することが可能です。

```
export JIA_ISU_UUID=0694e4d7-dfce-4aec-b7ca-887ac42cfb8f
curl -XPOST -H 'content-type: application/json' http://localhost:3000/api/condition/${JIA_ISU_UUID} \
-d '[{"is_sitting": true, "condition": "is_dirty=true,is_overweight=true,is_broken=true","message":"test","timestamp": 1628492991}]'
```

この他にも [SSH Remote Port Forwarding](https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding#Remote_Port_Forwarding) を利用する方法がありますが、詳細は省略します。

### 3. 負荷走行 (ベンチマーク)

** ToDo **
- ポータルサイトのページ名を確認し修正
- 可能であれば参加者を「選手」もしくは「予選参加者」に修正

負荷走行はポータルサイト上からリクエストします。
ポータルサイトの [競技参加者向けページ](https://portal.isucon.net/contestant) にアクセスし、 "Job Enqueue Form" から負荷走行対象のサーバーを選択、"Enqueue" をクリックすることで負荷走行のリクエストが行われ、順次開始されます。

なお、負荷走行が待機中 (PENDING) もしくは実行中 (RUNNING) の間は追加の Enqueue を行うことはできません。


### 参考実装

下記の言語での実装が提供されています。

- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

### 参考実装の切り替え方法

初期状態では Go による実装が起動しています。

各言語実装は systemd で管理されています。
例えば、参考実装を Go から Ruby に切り替えるには次のようにします。

```shell
sudo systemctl disable --now isucondition.go.service

sudo systemctl enable --now isucondition.ruby.service
```

### 時計について

主催者が管理するベンチマーカーについては、Amazon Time Sync Service (169.254.169.123) と systemd-timesyncd を利用して時刻同期が設定されています。

選手へ提供されるサーバーについても、初期状態で同様の設定がされています。

### ISUの仮想時間について

ベンチマーカーが模すISUの世界では現実時間の1秒を3万倍(30,000秒)加速した時間が流れており、ISUはこの仮想時間を使ったデータを送信します。

## 負荷走行について

ベンチマーカーによる負荷走行は以下のように実施されます。

1. 初期化処理の実行 `POST /initialize` (20 秒でタイムアウト)
2. アプリケーション互換性チェック (数秒～数十秒)
3. 負荷走行 (60 秒)

初期化処理は 20 秒以内に完了する必要があります。これを超えた場合、負荷走行は失敗になります。

アプリケーション互換性チェックが通らなかった場合、その負荷走行は失敗となります。

### キャッシュについて

アプリケーションは下記の条件においてキャッシュが認められています。

- `GET /api/trend`, `/api/condition/:jia_isu_uuid`, `GET /api/isu/:jia_isu_uuid/graph`
  - アプリケーションは、古い情報を返すことができます。ただし、これは後述の「スコア計算」において得点の加算を受ける機会が減る可能性があるに留意してください。
  - `POST /initialize` によって生成される初期データに対しては、反映されていることを期待してベンチマーカーは検証を行います。
- 上記以外の HTTP リクエスト
  - データの更新が即時反映されていることを期待してベンチマーカーは検証を行います。ただし、ベンチマーカーが検知しない限りは古い情報を返しても構いません。

### タイムアウトについて

ToDo: ベンチと確認&意識合わせ
ベンチマーカーにおいて設定されているタイムアウト値は下記の通りです。

- `POST /initialize`
  - 20 秒以内にレスポンスを返す必要があります。これを超えた場合、負荷走行は即時失敗します。
- `POST /api/condition/:jia_isu_uuid`
  - 100 ミリ秒を超えるとタイムアウトしますが、後述のスコア計算にあるように減点の対象とはなりません。
- 上記以外の HTTP リクエスト
  - 1 秒以内にレスポンスを返す必要があります。これを超えた場合、後述のスコア計算に従い減点の対象となります。
  - (MEMO: 解いてもらう会では5秒に設定。要調整)

なお、負荷走行終了時点でレスポンスを返していないリクエストについては強制的に切断され、上記のタイムアウト時間にかかわらずタイムアウトとして処理されます。

### 負荷走行終了後に起こるDBの高負荷状態の解消について

負荷走行終了後にDBの高負荷状態が続くことがあります。
これはアプリケーションからDBへのクエリが継続している場合があります。

DBへの高負荷状態を解消するためには以下のように動作中のISUCONDITIONサービスを再起動してください。

```
sudo systemctl restart isucondition.go
```

## スコア計算

負荷走行のスコアは下記の加点と減点から算出されます。

### 負荷走行時における加点について

スコアはユーザが下記のようにISUのコンディションやグラフを確認することで加点されます。

- ISUのコンディション確認 (/isu/:jia_isu_uuid/condition) でユーザが新しく確認できたISUのコンディションとその数に応じた加点(過去に確認済みのコンディションでは加点されません)
  - Info(3点)
  - Warning(2点)
  - Critical(1点)
- ISUのグラフ確認でユーザがまだ確認していないグラフの確認に成功した時、確認したグラフを構成するデータに応じた得点を加点（後述）
  - 過去のグラフは過去に見たことがある日付まで遡り、まだ見たことがないグラフを最初に確認したときに得点を加点。
  - コンディションが送られてきている当日のグラフは、前回のグラフ確認からグラフを構成するデータが増えていることを確認した場合、再度得点を加点。

#### グラフの確認による加点

グラフの確認による加点は、グラフを構成する1時間毎のデータの中に含まれる最少のコンディション数 (n) に応じて下記の表を元に得点を加点します。

| レベル     | 得点  | 条件         |
|-----------|------|--------------|
| Excellent | 5    | 30 <= n      |
| Good      | 4    | 20 <= n < 30 |
| Normal    | 3    | 10 <= n < 20 |
| Bad       | 2    | 5  <= n < 10 |
| Worst     | 1    | 0  <= n < 5  |

  - ToDo：上記の得点や条件は仮のもののため調整が終わり次第書き換える

### 負荷走行時における減点、即時失敗（fail) について

負荷走行時に発生するエラーによっては、減点や即時失敗（fail）となります。条件は以下の通りです。

- アプリケーション互換性チェック、もしくはデータ整合性チェックに失敗した
  - 1 回あたり減点 1 点
  - 100 回の失敗時点で即時失敗とする

- リクエストがタイムアウトした場合 (条件は前項に記載)
  - 10 回あたり減点 1 点
  - 即時失敗は無し

- `POST /api/condition/:jia_isu_uuid` は上記の減点に該当せず、一切の減点を行いません。

## 最終スコア

競技時間終了後、再起動後に主催者によって実行された負荷走行のスコアを最終スコアとします。

### 制約事項

以下の事項に抵触すると失格 (fail) となり、点数が 0 点になります。

- POST /initialize へのレスポンスを 20 秒以内に返さない場合
- 負荷走行前のアプリケーション互換性チェックに失敗した場合
- 負荷走行中のアプリケーション互換性チェック、もしくはデータ整合性チェックに　100　回失敗した
- その他、ベンチマーカーが失敗を検出したケース

最初に呼ばれる初期化処理 POST /initialize は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。 
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。

予選終了後に行われる主催者による確認作業 （追試） において下記の点が確認できなかった場合は失格となります。

- アプリケーションは全保存データを永続化していること
  - ベンチマーク実施後に再起動が行われた場合、直前まで行われていた内容が保存されている必要があります
- アプリケーションはブラウザ上での表示を初期状態と同様に保っていること

### `POST /initialize` での実装言語の出力

`POST /initialize` レスポンスにて、本競技で利用した言語を出力してください。 集計し [blog](https://isucon.net/) での公表や、参考情報として利用させていただきます。

`POST /initialize` のレスポンスは次のような JSON 形式となります。

```
{
    "language": "実装言語"
}
```

language の値が実装に利用した言語となります。 language が空の場合はベンチマーカーに失敗と見なされます。

# レギュレーション

## ソフトウェア事項

選手は主催者からWebアプリケーション (問題) が与えられ、選手は競技時間内にその Web アプリケーションの高速化を行う。
選手は高速化された実装 (回答) を作成する時、主催者より与えられたソフトウェア (初期実装) をベースに実装しても良いし、しなくても良い。 
下記の環境に記載されているプログラミング言語で初期実装が提供されるが、その各々の性能が一致することは保証されない。

提供される初期実装
- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

高速化の際、主催者より問題として与えられた Web アプリケーションから、以下の部分は変更しないこと。

- アクセス先のURI、ただしサーバー側で生成する部分（IDなど）は文字種（[0-9] や [0-9a-zA-Z_] など）を変えない範囲で自由に生成しても良い
- レスポンス (HTMLのDOM, JSONオブジェクト等) の構造
- JavaScript/CSSファイルの内容
- 画像および動画等のメディアファイルの内容

各サーバーにおけるソフトウェアの入れ替え、設定の変更、アプリケーションコードの変更および入れ替えなどは一切禁止しない。
ベンチマーク中にポータル・マニュアル・レギュレーションといった、主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。 ただしモニタリングやテスト、開発などにおいては、PCや外部のサーバーを利用しても構わない。

許可される事項には、例として以下のような作業が含まれる。

- 複数台あるサーバーの役割の変更
- データベーススキーマの変更やインデックスの作成・削除
- データベースに利用するミドルウェアの変更
- キャッシュ機構の追加、ジョブキュー機構の追加による遅延書き込み
- 他の言語による再実装

ただし以下の事項に留意すること。

- サーバー再起動後にすべてのアプリケーションコードが正常動作する状態を維持すること
- ベンチマーク実行時にアプリケーションに書き込まれたデータは再起動後にも取得できること

## 禁止事項

以下の行為を特に禁止する。

- 競技終了時間までに、競技の内容に関するあらゆる事項 (問題内容・計測ツールの計測方法など)を公開・共有すること(内容を推察できる発言も含む)
  - 不特定多数への公開はもちろん、他チームの選手と連絡を取り、問題内容等を共有する事 (結託行為) も禁止とする。
  - ただし主催者が Twitter, Web サイトにおいて公開している情報は除く。ポータルでログインを要するページにおいて記載されている内容は公開情報でない旨留意すること。
- 競技時間中、チーム外の人物と ISUCON11 問題にまつわる事項のやりとり (ISUCON11 選手であるかどうかを問わない、SNS での発言も含む)
- 主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。
  - ただしモニタリングやテスト、開発などにおいては、PCや外部のサーバーを利用しても構わない。
- 選手が主催者からその選手が属するチームへ提供されていないサーバーについて直接のアクセスを試みる行為や、外部への不正アクセスを試みる行為。具体的にはベンチマーカーへのログイン試行等。(なお、例示のため、これに限らない。)
- 他チームと結託する行為 (程度を問わず)
- 主催者が他チームへの妨害、競技への支障となるとみなす全ての行為


本マニュアルやレギュレーション, ポータルサイトにおいて禁止とされた行為 (禁止事項) への違反は、失格となる。
