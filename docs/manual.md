# ISUCON11 予選当日マニュアル

**本マニュアルならびに、[ISUCON11 予選レギュレーション](https://isucon.net/archives/55854734.html) をご確認ください。**
**本マニュアルとレギュレーションの内容に矛盾がある場合、本マニュアルの内容が優先されます**

## スケジュール

- 10:00 競技開始
- 19:00 ポータルサイト リーダーボードの更新停止
- 20:00 競技終了
- 以降、主催者により結果チェック、追試

## 課題アプリケーション ISUCONDITION について

### 課題アプリケーション仕様

課題アプリケーション ISUCONDITION の仕様については、[ISUCONDITON アプリケーションマニュアル]()を参照してください。

## ISUCON11 予選 ポータルサイト

ISUCON11 予選競技は下記ポータルサイトを利用します。
事前に登録した情報を用いてログインしてください。
なお、このページは競技開始時刻までアクセスすることはできません。

ポータルサイトでは、ベンチマークの実行・結果確認、質問/サポート依頼の送信、リーダーボードの確認ができます。

https://portal.isucon.net/contestant

### リーダーボードの更新について

ポータルサイト上のリーダーボードのスコアは、競技終了前の 1 時間は他チームのスコアが更新されなくなり、自チームのスコアのみ確認が可能になります。

### Discord の利用について

ISUCON 11 サポート Discord サーバは競技中ならびにその前後の時間はすべてのチャンネルが発言不可となります。
競技時間中はポータルサイトを通して質問やサポート依頼を送信することができますので、そちらを利用してください。

ただし、予選参加者（以下選手）は競技時間中も Discord の確認が可能な状態、通知が受け取れる状態を維持してください。
これはポータルで送信した質問/サポート依頼の内容を主催者が確認した上で、リアルタイムでのチャットが必要だと判断した場合、主催者が Discord 上でプライベートチャンネルを作成し、mention の上よびかけを行う場合があるためです。

また、アナウンス等も Discord で実施されます。

### 質問について

選手は主催者へ質問を送信することができる。質問は競技内容・マニュアル・レギュレーション等に対する疑問点・明確にしたい事項の確認や、サーバー障害などのトラブル報告・サポート依頼に利用することができるが、これに限らない。

主催者は質問された内容について競技の一環である場合は、回答できない旨返答することがある。

競技時間中の質問について、主催者からの回答は全選手へ公開、あるいは個別に回答される。全選手へ公開される場合、質問内容の原文、あるいは主催者による内容の要約が公開される。未回答の質問・未公開の回答については質問した選手およびそのチームメンバー、主催者のみが確認できる。質問への回答/更新はポータル上にて選手およびそのチームへ通知される。

主催者は競技時間中の質問への回答について、原則として全選手へ公開する。ただし、重複する質問や、選手およびチーム個別の問題 (サーバ障害など) に対する対応の場合、この限りではない。


## サーバ、ネットワーク構成について (ToDo)

予選Infra班、ポータルチームで相談
- [ ] どうやってサーバ3台を構築するか

上記のサーバに接続するために SSH 接続を行います。
[ssh_config(5)](https://man.openbsd.org/ssh_config.5) の例を以下に示します。なお、あくまで例示であり必ず以下の設定を利用する必要はありません。

```
 Host isucon-server
   HostName **<踏み台用IPアドレス>**
   User ubuntu
```

### 重要事項

- **競技に利用できる計算機資源は主催者が指定した 3 台のインスタンスのみです。** 
  - 特例として外部のメトリクス計測サービスの使用のみ許可をしますが、スコアを向上させるいかなる効果も持つものであってはいけません。
- **競技終了後は、ベンチマーク走行成績の追試を行いますので、Discord サーバ および http://isucon.net/ にて主催者からお知らせをするまで、サーバの操作はしないでください。**
  - 競技終了後の作業は禁止行為にあたり失格となります。
- **サーバ上の`ubuntu` ならびに `isucon` 以外のユーザーに関して、ユーザー削除や既存の公開鍵の削除、その他 sshd の設定変更等を行ったことにより、主催者による追試をおこなうことができない場合は、失格とします。**


## 作業手順

以下の順序で作業を開始してください。

### 1. サーバーへのログイン

上記に記載したサーバーに対して SSH 接続してください。
ログインには参加登録に利用した ( = ポータルのログインに利用している) GitHub アカウントに登録されている SSH 鍵を利用します。

SSH ログインのユーザ名は `ubuntu` です。

### 2. アプリケーションの動作確認 (ToDo)

アプリケーションは Web ブラウザから利用することができます。

踏み台を経由したブラウザアクセスには、 [SSH におけるローカルポートフォワーディング](https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding#Local_Port_Forwarding) などを用いて表示することができます。
これ以外の方法で動作確認してもかまいません。

以下に Team001 におけるローカルポートフォワーディングを実行するコマンドを例示します。
これは「リモートホスト `isucon-server` に SSH 接続をした上で」「ローカルの `localhost:3000` への TCP 接続を」「リモートホストを通して `10.160.1.101:3000` へ転送する」というコマンドです。

```shell
$ ssh -L localhost:3000:10.160.1.101:3000 isucon-server
```

以上を踏まえると、上記のコマンド例を実行している場合、 http://localhost:3000 でアプリケーションへアクセスすることができます。

#### アプリケーションへのログイン方法 (ToDo)

以下は http://localhost:3000 でアプリケーションへアクセスできるように設定した場合の例です。

- ISUCONDITION Topページ
  - http://localhost:3000/


下記の 4 ユーザが登録されているので、動作確認にご利用ください。ログインはトップページから行うことができます。

| ログイン ID (contestant_id) | パスワード | 備考     |
| --------------------------- | ---------- | -------- |
| isucon                      | isucon     | 初期ユーザ |
| isucon1                     | isucon1    | 初期ユーザ |
| isucon2                     | isucon2    | 初期ユーザ |
| isucon3                     | isucon3    | 初期ユーザ |

#### ISUの登録に使えるIsuIDについて

アプリケーションの動作確認用に以下のJIA IsuIDが使えます

| JIA IsuID |
| --------- |
| 0694e4d7-dfce-4aec-b7ca-887ac42cfb8f |
| 3a8ae675-3702-45b5-b1eb-1e56e96738ea |
| 3efff0fa-75bc-4e3c-8c9d-ebfa89ecd15e |
| f67fcb64-f91c-4e7b-a48d-ddf1164194d0 |
| 32d1c708-e6ef-49d0-8ca9-4fd51844dcc8 |
| f012233f-c50e-4349-9473-95681becff1e |
| af64735c-667a-4d95-a75e-22d0c76083e0 |
| cb68f47f-25ef-46ec-965b-d72d9328160f |
| 57d600ef-15b4-43bc-ab79-6399fab5c497 |
| aa0844e6-812d-41d2-908a-eeb82a50b627 |


#### データベースの初期化方法

初期状態のアプリケーションでは、初期化処理（`POST /initialize`）においてデータベースのレコードを削除し、スキーマは初期化します。


#### 動作確認に便利なスクリプト集

**ToDo**

### 3. 負荷走行 (ベンチマーク)

**2021.7.10 準備会向け**

1. ベンチマークサーバにログイン（ユーザ名 `ubuntu`）
2. ベンチマークツールの設定と実行
  
```bash
export ISUXPORTAL_TARGET="競技者インスタンスのアドレス"
export JIA_SERVICE_URL="http://$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4):80"
cd /home/isucon/bench
./bench -target ${ISUXPORTAL_TARGET} -jia-service-url ${JIA_SERVICE_URL} -initialize-timeout 60s
```

---

**以下、予選当日向けのため準備会とは関係なし**


**予選当日向け(ToDo)**

負荷走行はポータルサイト上からリクエストします。
ポータルサイトの [競技参加者向けページ](https://portal.isucon.net/contestant) にアクセスし、 "Job Enqueue Form" から負荷走行対象のサーバーを選択、"Enqueue" をクリックすることで負荷走行のリクエストが行われ、順次開始されます。

なお、負荷走行が待機中 (PENDING) もしくは実行中 (RUNNING) の間は追加の Enqueue を行うことはできません。


### 参考実装

下記の言語での実装が提供されています。

- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

### 参考実装の切り替え方法(ToDo /w infra)

初期状態では Go による実装が起動しています。

各言語実装は systemd で管理されています。
例えば、参考実装を Go から Ruby に切り替えるには次のようにします。

```shell
sudo systemctl disable --now isucondition.go.service

sudo systemctl enable --now isucondition.ruby.service (ToDo)
```

### `/etc/hosts` および `*` ドメインについて (ToDo)

TBD

### 時計について (ToDo w/ infra)

TBD (下記は10-finalの記述)
```
主催者が管理するベンチマーカーについては、Google Public NTP サーバー (time1.google.com, time2.google.com, time3.google.com, time4.google.com) と systemd-timesyncd を利用して時刻同期が設定されています。

選手へ提供されるサーバーについても、初期状態で同様の設定がされています。
```

## 負荷走行について (ToDo w/ benchmark)

ベンチマーカーによる負荷走行は以下のように実施されます。

**下記は10-finalの記述**

```
1. 初期化処理の実行 `POST /initialize` ({initialize_timeout} 秒でタイムアウト)
2. アプリケーション互換性チェック (数秒～数十秒)
3. 初期化処理の実行 `POST /initialize` ({initialize_timeout} 秒でタイムアウト)
4. 負荷走行 (60 秒)
5. 待ち時間 (5 秒)
6. 整合性チェック (数秒〜数十秒)

初期化処理は 2 回実行され、それぞれ 20 秒以内に完了する必要があります。これを超えた場合、負荷走行は失敗になります。

ベンチマーカーは負荷走行終了ののち、5 秒待ってから整合性チェックを行います。
ジョブキューによる遅延処理等を追加した場合は、このタイミングまでに処理の整合性をとってください。

負荷走行終了後、{request_timeout} 秒経ってもレスポンスが返ってきていないリクエストはすべて強制的に切断され、タイムアウトとして数えられます。

アプリケーション互換性チェックもしくは整合性チェックが通らなかった場合、その負荷走行は失敗となります。
```

### キャッシュについて（ToDo）

TBD（やるなら書く、やらないなら削除）

### タイムアウトについて（ToDo）

TBD（ベンチと確認）

## スコア計算

負荷走行のスコアは以下の計算式によって算出されます。

```
スコア = ISUユーザスコア + ISUスコア - 減点
```

- ISUユーザスコア
  - ユーザの新規登録が成功する(10点)
  - ユーザの動作シナリオが成功する(10点)

- ISUスコア
  - コンディションの送信に成功時
    - Info(2点)
    - Warning(1点)
    - Critical(0点)

負荷走行時に発生するエラーによっては、減点されたり、即時失敗（fail）したりします。条件は以下の通りです。

減点の説明

- アプリケーション互換性チェック、もしくは整合性チェックに失敗した
  - 1 回あたり減点 50 点
  - 即時失敗は無し

- HTTP ステータスコードやレスポンス内容などに誤りがある
  - 1 回あたり減点 1 点
  - 即時失敗は無し

- リクエストがタイムアウトした場合 (条件は前項に記載)
  - 10 回あたり減点 1 点
  - 即時失敗は無し

## 最終スコア

競技時間終了後、再起動後に主催者によって実行された負荷走行のスコアを最終スコアとします。

### 制約事項（ToDo）

以下の事項に抵触すると失格 (fail) となり、点数が 0 点になります。

- POST /initialize へのレスポンスを (TBD) 秒以内に返さない場合
- アプリケーション互換性チェックに失敗した場合
- その他、ベンチマーカーが失敗を検出したケース

最初に呼ばれる初期化処理 POST /initialize は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。 サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。

予選終了後に行われる主催者による確認作業 （追試） において下記の点が確認できなかった場合は失格となります。

- アプリケーションは全保存データを永続化していること
  - ベンチマーク実施後に再起動が行われた場合、直前まで行われていた内容が保存されている必要があります
- アプリケーションはブラウザ上での表示を初期状態と同様に保っていること

### `POST /initialize` での実装言語の出力

`POST /initialize` レスポンスにて、本競技で利用した言語を出力してください。 集計し [blog](https://isucon.net/) での公表や、参考情報として利用させていただきます。

`POST /initialize` のレスポンスは次のような JSON 形式となります。

```
{
    "language": "実装言語"
}
```

language の値が実装に利用した言語となります。 language が空の場合はベンチマーカーに失敗と見なされます。

# レギュレーション

## ソフトウェア事項

選手は主催者からWebアプリケーション (問題) が与えられ、選手は競技時間内にその Web アプリケーションの高速化を行う。選手は高速化された実装 (回答) を作成する時、主催者より与えられたソフトウェア (初期実装) をベースに実装しても良いし、しなくても良い。 下記の環境に記載されているプログラミング言語で初期実装が提供されるが、その各々の性能が一致することは保証されない。

提供される初期実装
- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

高速化の際、主催者より問題として与えられた Web アプリケーションから、以下の部分は変更しないこと。

- アクセス先のURI、ただしサーバー側で生成する部分（IDなど）は文字種（[0-9] や [0-9a-zA-Z_] など）を変えない範囲で自由に生成しても良い
- レスポンス (HTMLのDOM, JSONオブジェクト等) の構造
- JavaScript/CSSファイルの内容
- 画像および動画等のメディアファイルの内容

各サーバにおけるソフトウェアの入れ替え、設定の変更、アプリケーションコードの変更および入れ替えなどは一切禁止しない。
ベンチマーク中にポータル・マニュアル・レギュレーションといった、主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。 ただしモニタリングやテスト、開発などにおいては、PCや外部のサーバーを利用しても構わない。

許可される事項には、例として以下のような作業が含まれる。

- 複数台あるサーバーの役割の変更
- データベーススキーマの変更やインデックスの作成・削除
- データベースに利用するミドルウェアの変更
- キャッシュ機構の追加、ジョブキュー機構の追加による遅延書き込み
- 他の言語による再実装

ただし以下の事項に留意すること。

- コンテスト進行用のメンテナンスコマンドが正常に動作するよう互換性を保つこと
- サーバ再起動後にすべてのアプリケーションコードが正常動作する状態を維持すること
- ベンチマーク実行時にアプリケーションに書き込まれたデータは再起動後にも取得できること

## 禁止事項

以下の行為を特に禁止する。

- 競技終了時間までに、競技の内容に関するあらゆる事項 (問題内容・計測ツールの計測方法など)を公開・共有すること(内容を推察できる発言も含む)
  - 不特定多数への公開はもちろん、他チームの選手と連絡を取り、問題内容等を共有する事 (結託行為) も禁止とする。
  - ただし主催者が Twitter, Web サイトにおいて公開している情報は除く。ポータルでログインを要するページにおいて記載されている内容は公開情報でない旨留意すること。
- 競技時間中、チーム外の人物と ISUCON11 問題にまつわる事項のやりとり (ISUCON11 選手であるかどうかを問わない、SNS での発言も含む)
- 主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。
  - ただしモニタリングやテスト、開発などにおいては、PCや外部のサーバーを利用しても構わない。
- 選手が主催者からその選手が属するチームへ提供されていないサーバーについて直接のアクセスを試みる行為や、外部への不正アクセスを試みる行為。具体的にはベンチマーカーへのログイン試行等。(なお、例示のため、これに限らない。)
- 他チームと結託する行為 (程度を問わず)
- 主催者が他チームへの妨害、競技への支障となるとみなす全ての行為


本マニュアルやレギュレーション, ポータルサイトにおいて禁止とされた行為 (禁止事項) への違反は、失格となる。