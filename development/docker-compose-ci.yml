version: "3.8"
services:
  backend:
    build:
      context: ..
      dockerfile: development/backend-${target}/ci.dockerfile
    working_dir: /webapp/go
    entrypoint: ["dockerize", "-wait=tcp://mysql-backend-ci:3306", "-timeout=60s", "./app"]
    environment:
      MYSQL_HOST: mysql-backend-ci
      MYSQL_PORT: 3306
      MYSQL_DATABASE: isucondition
      MYSQL_USER: isucon
      MYSQL_PASSWORD: isucon
    ports:
      - "3000:3000"
    volumes:
      - "../webapp/frontend:/webapp/frontend"
      - "../webapp/mysql:/webapp/mysql"
      - "../webapp/ec256-public.pem:/webapp/ec256-public.pem"
    depends_on:
      - mysql-backend-ci

  mysql-backend-ci:
    image: mysql:8.0.25
    restart: always
    environment:
      MYSQL_DATABASE: isucondition
      MYSQL_USER: isucon
      MYSQL_PASSWORD: isucon
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - "../development/mysql-backend/mysql.cnf:/etc/mysql/conf.d/mysql.cnf"  
      - "../webapp/mysql/db/0_Schema.sql:/docker-entrypoint-initdb.d/0_Schema.sql"
    expose:
      - "3306"
    ports:
      - "3306:3306"

  apitest:
    build:
      context: ..
      dockerfile: development/apitest/ci.dockerfile
    environment:
      TARGET_ADDRESS: backend:3000
    depends_on:
      - mysql-backend-ci
      - backend
